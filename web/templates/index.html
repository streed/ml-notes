<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Notes</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    {{if .Config.WebUICustomCSS}}
    <link rel="stylesheet" href="/static/css/custom.css">
    {{end}}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Embedded Graph Styles */
        .embedded-graph-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--paper-bg);
            margin: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            box-shadow: 0 8px 32px rgba(var(--shadow-color), 0.12);
            overflow: hidden;
        }

        .embedded-graph-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .embedded-graph-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .graph-header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .graph-stats {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .embedded-graph-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--paper-bg);
        }

        .embedded-graph-tooltip {
            position: absolute;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(var(--shadow-color), 0.15);
            pointer-events: none;
            z-index: 20;
            max-width: 250px;
        }

        .embedded-graph .node {
            stroke: var(--border-color);
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .embedded-graph .node:hover {
            stroke-width: 3px;
            filter: brightness(1.1);
        }

        .embedded-graph .link {
            stroke: var(--border-color);
            stroke-opacity: 0.4;
            stroke-width: 1px;
        }

        .embedded-graph .node-label {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 500;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
            dominant-baseline: central;
        }

        /* Delete Modal Styles */
        .delete-confirmation {
            text-align: center;
            padding: 20px 0;
        }

        .delete-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .delete-confirmation h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .delete-warning {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .note-preview-delete {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            font-size: 14px;
            color: var(--text-primary);
            text-align: left;
        }

        .note-preview-delete strong {
            color: var(--text-secondary);
        }

        /* Resizable Split Pane Styles */
        .split-pane-container {
            display: flex;
            height: 100%;
            position: relative;
        }

        .editor-pane {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            width: 0; /* Start completely hidden */
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .preview-pane {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .split-resize-handle {
            width: 6px;
            background: var(--border-color);
            cursor: ew-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease;
        }

        .split-resize-handle:hover {
            background: var(--accent-color);
        }

        .resize-grip {
            width: 3px;
            height: 20px;
            background: var(--text-tertiary);
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.2s ease;
        }

        .split-resize-handle:hover .resize-grip {
            opacity: 0.8;
        }

        /* States for split pane */
        .split-pane-container.focus-editor .editor-pane {
            width: 50%;
        }

        .split-pane-container.focus-preview .editor-pane {
            width: 0;
        }

        .split-pane-container.resizing .editor-pane {
            transition: none; /* Disable transition during manual resize */
        }

        /* Textarea adjustments */
        .note-textarea {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.9;
            padding: 20px 16px;
            resize: none;
            font-family: 'Crimson Text', 'Libre Baskerville', Georgia, serif;
            font-weight: 400;
            border-radius: 0;
            position: relative;
            z-index: 2;
            letter-spacing: 0.01em;
        }

        .note-textarea:focus {
            outline: none;
            box-shadow: none;
        }

        /* Preview area adjustments */
        .note-preview-area {
            flex: 1;
            padding: 20px 16px;
            background: transparent;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.9;
            font-family: 'Crimson Text', 'Libre Baskerville', Georgia, serif;
            color: var(--text-primary);
        }


        /* Responsive behavior */
        @media (max-width: 768px) {
            .split-pane-container {
                flex-direction: column;
            }
            
            .split-resize-handle {
                display: none;
            }
            
            .editor-pane {
                width: 100% !important;
                height: 50%;
            }
            
            .preview-pane {
                height: 50%;
            }
        }
    </style>
</head>
<body data-theme="{{if .Config.WebUITheme}}{{.Config.WebUITheme}}{{else}}light{{end}}">
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <a href="/" class="app-title" style="text-decoration: none; color: inherit;">üìù ML Notes</a>
                <div class="stats">
                    <span class="stat-item">{{.Stats.TotalNotes}} notes</span>
                    {{if .Stats.VectorSearch}}<span class="stat-item">üîç Vector Search</span>{{end}}
                    {{if .Stats.AutoTagging}}<span class="stat-item">üè∑Ô∏è Auto-tagging</span>{{end}}
                </div>
            </div>
            <div class="header-right">
                <button id="new-note-btn" class="btn btn-primary">
                    <span class="btn-icon">+</span>
                    New Note
                </button>
                <a href="/graph" class="btn btn-secondary" title="View notes graph">
                    <span class="btn-icon">üìä</span>
                    Graph
                </a>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search notes..." class="search-input">
                    <button id="search-btn" class="search-btn">üîç</button>
                </div>
                <button id="theme-toggle" class="btn btn-icon-only" title="Toggle theme">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>Notes</h3>
                    <div class="sidebar-controls">
                        <select id="tag-filter" class="tag-filter">
                            <option value="">All Tags</option>
                            {{range .Tags}}
                            <option value="{{.Name}}">{{.Name}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
                
                <div class="notes-list" id="notes-list">
                    {{if .Notes}}
                        {{range .Notes}}
                        <div class="note-item {{if eq $.CurrentNote.ID .ID}}active{{end}}" data-note-id="{{.ID}}" data-tags="{{range .Tags}}{{.}} {{end}}">
                            <div class="note-title">{{.Title}}</div>
                            <div class="note-preview">{{printf "%.100s" .Content}}{{if gt (len .Content) 100}}...{{end}}</div>
                            <div class="note-meta">
                                <span class="note-date">{{.CreatedAt.Format "Jan 2, 2006"}}</span>
                                {{if .Tags}}
                                <div class="note-tags">
                                    {{range .Tags}}
                                    <span class="tag">{{.}}</span>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="empty-state">
                            <p>No notes yet. Create your first note!</p>
                        </div>
                    {{end}}
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="editor-container">
                    {{if .CurrentNote}}
                        <!-- Note Editor -->
                        <div class="note-editor paper-page paper-shadow-lg" id="note-editor">
                            <div class="editor-header">
                                <input type="text" id="note-title" class="note-title-input" value="{{.CurrentNote.Title}}" placeholder="{{if .IsNewNote}}Enter your note title...{{else}}Note title...{{end}}">
                                <div class="editor-actions">
                                    {{if not .IsNewNote}}
                                    <button id="toggle-preview" class="btn btn-secondary">
                                        <span id="preview-icon">üëÅÔ∏è</span>
                                        <span id="preview-text">Preview</span>
                                    </button>
                                    <button id="auto-tag-btn" class="btn btn-secondary" {{if not .Stats.AutoTagging}}disabled{{end}}>
                                        üè∑Ô∏è Auto-tag
                                    </button>
                                    <button id="analyze-btn" class="btn btn-secondary">
                                        ü§ñ Analyze
                                    </button>
                                    {{end}}
                                    <button id="save-note" class="btn btn-primary">{{if .IsNewNote}}Create Note{{else}}Save{{end}}</button>
                                    {{if not .IsNewNote}}
                                    <button id="delete-note" class="btn btn-danger">Delete</button>
                                    {{end}}
                                </div>
                            </div>

                            <!-- Tags Section -->
                            <div class="tags-section">
                                <label>Tags:</label>
                                <div class="tags-input-container">
                                    <input type="text" id="note-tags" placeholder="Add tags (comma-separated)" value="{{range $i, $tag := .CurrentNote.Tags}}{{if $i}}, {{end}}{{$tag}}{{end}}">
                                </div>
                                <div class="current-tags" id="current-tags">
                                    {{range .CurrentNote.Tags}}
                                    <span class="tag removable" data-tag="{{.}}">{{.}} <span class="tag-remove">√ó</span></span>
                                    {{end}}
                                </div>
                            </div>

                            <!-- Editor/Preview Area -->
                            <div class="editor-area">
                                <div class="split-pane-container" id="split-pane-container">
                                    <div class="editor-pane" id="editor-pane">
                                        <textarea id="note-content" class="note-textarea" placeholder="{{if .IsNewNote}}Start writing your note here...{{else}}Start writing your note...{{end}}">{{.CurrentNote.Content}}</textarea>
                                    </div>
                                    <div class="split-resize-handle" id="split-resize-handle">
                                        <div class="resize-grip"></div>
                                    </div>
                                    <div class="preview-pane" id="preview-pane">
                                        <div id="note-preview" class="note-preview-area"></div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="current-note-id" value="{{.CurrentNote.ID}}">
                            <input type="hidden" id="is-new-note" value="{{.IsNewNote}}">
                        </div>
                    {{else}}
                        {{if and .Notes (gt (len .Notes) 1)}}
                            <!-- Embedded Graph View -->
                            <div class="embedded-graph-container">
                                <div class="embedded-graph-header">
                                    <h2>üìä Notes Graph</h2>
                                    <div class="graph-header-actions">
                                        <span class="graph-stats" id="embedded-graph-stats">{{len .Notes}} notes</span>
                                        <a href="/graph" class="btn btn-secondary">Full View</a>
                                    </div>
                                </div>
                                <div class="embedded-graph-content">
                                    <svg id="embedded-graph" width="100%" height="100%"></svg>
                                    <div class="embedded-graph-tooltip" id="embedded-tooltip" style="display: none;"></div>
                                </div>
                            </div>
                        {{else}}
                            <!-- Welcome Screen for Empty State -->
                            <div class="welcome-screen">
                                <div class="welcome-content">
                                    <h2>Welcome to ML Notes</h2>
                                    <p>Start creating notes to see them visualized as an interactive graph.</p>
                                    <button id="create-first-note" class="btn btn-primary btn-large">
                                        Create Your First Note
                                    </button>
                                </div>
                            </div>
                        {{end}}
                    {{end}}
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;"></div>
    
    <!-- Analysis Modal -->
    <div id="analysis-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Note Analysis</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="analysis-options">
                    <label>
                        <input type="checkbox" id="analysis-write-back"> Write analysis back to note
                    </label>
                    <label>
                        <input type="checkbox" id="analysis-write-new"> Create new note with analysis
                    </label>
                    <div id="analysis-title-input" style="display: none;">
                        <input type="text" placeholder="Analysis note title..." id="analysis-title">
                    </div>
                    <div class="prompt-input">
                        <label for="analysis-prompt">Custom prompt (optional):</label>
                        <textarea id="analysis-prompt" placeholder="e.g., Focus on technical details, Extract key insights..."></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button id="run-analysis" class="btn btn-primary">Analyze</button>
                </div>
            </div>
            <div id="analysis-result" class="analysis-result" style="display: none;">
                <div class="analysis-content"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Note</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation">
                    <div class="delete-icon">üóëÔ∏è</div>
                    <h4 id="delete-note-title">Are you sure you want to delete this note?</h4>
                    <p class="delete-warning">This action cannot be undone. The note and all its content will be permanently deleted.</p>
                    <div class="note-preview-delete">
                        <strong>Note:</strong> <span id="delete-preview-title"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button id="confirm-delete" class="btn btn-danger">Delete Note</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Embedded Graph Functionality
        class EmbeddedGraph {
            constructor() {
                this.container = document.getElementById('embedded-graph');
                this.tooltip = document.getElementById('embedded-tooltip');
                
                if (!this.container) return;
                
                this.init();
                this.loadData();
            }
            
            init() {
                const containerRect = this.container.closest('.embedded-graph-content').getBoundingClientRect();
                this.width = containerRect.width || 800;
                this.height = containerRect.height || 600;
                
                this.svg = d3.select(this.container)
                    .attr('width', this.width)
                    .attr('height', this.height)
                    .attr('class', 'embedded-graph');
                
                this.g = this.svg.append('g');
                
                // Simple zoom (no complex controls for embedded view)
                const zoom = d3.zoom()
                    .scaleExtent([0.3, 3])
                    .on('zoom', (event) => {
                        this.g.attr('transform', event.transform);
                    });
                
                this.svg.call(zoom);
                
                this.linkGroup = this.g.append('g').attr('class', 'links');
                this.nodeGroup = this.g.append('g').attr('class', 'nodes');
                this.labelGroup = this.g.append('g').attr('class', 'labels');
            }
            
            async loadData() {
                try {
                    const response = await fetch('/api/v1/graph?max_nodes=30&min_connections=1');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.render(data.data);
                        this.updateStats(data.data.nodes.length, data.data.links.length);
                    }
                } catch (error) {
                    console.error('Error loading embedded graph:', error);
                }
            }
            
            updateStats(nodeCount, linkCount) {
                const statsEl = document.getElementById('embedded-graph-stats');
                if (statsEl) {
                    statsEl.textContent = `${nodeCount} notes, ${linkCount} connections`;
                }
            }
            
            render(data) {
                this.nodes = data.nodes.map(node => ({
                    ...node,
                    x: Math.random() * this.width,
                    y: Math.random() * this.height
                }));
                
                this.links = data.links.map(link => ({
                    ...link,
                    source: this.nodes.find(n => n.id === link.source),
                    target: this.nodes.find(n => n.id === link.target)
                }));
                
                // Create simulation with special handling for isolated nodes
                this.simulation = d3.forceSimulation(this.nodes)
                    .force('link', d3.forceLink(this.links)
                        .id(d => d.id)
                        .distance(80)
                        .strength(0.6)
                    )
                    .force('charge', d3.forceManyBody()
                        .strength(d => {
                            // Reduce repulsion for isolated nodes (no connections)
                            return d.size === 0 ? -30 : -200;
                        })
                    )
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(d => this.getNodeRadius(d) + 3))
                    // Add a positioning force to keep isolated nodes closer to center
                    .force('position', d3.forceRadial()
                        .radius(d => {
                            // Keep isolated nodes closer to center
                            if (d.size === 0) {
                                return Math.min(this.width, this.height) * 0.15; // 15% from center
                            }
                            return Math.min(this.width, this.height) * 0.35; // 35% from center for connected nodes
                        })
                        .x(this.width / 2)
                        .y(this.height / 2)
                        .strength(d => d.size === 0 ? 0.4 : 0.1) // Stronger for isolated nodes
                    );
                
                // Render links
                const link = this.linkGroup.selectAll('.link')
                    .data(this.links)
                    .enter().append('line')
                    .attr('class', 'link')
                    .attr('stroke-width', d => 1 + d.weight * 2);
                
                // Render nodes
                const node = this.nodeGroup.selectAll('.node')
                    .data(this.nodes)
                    .enter().append('circle')
                    .attr('class', 'node')
                    .attr('r', d => this.getNodeRadius(d))
                    .attr('fill', d => this.getNodeColor(d))
                    .call(this.drag());
                
                // Render labels (only for larger nodes to avoid clutter)
                const label = this.labelGroup.selectAll('.node-label')
                    .data(this.nodes.filter(d => d.size >= 2))
                    .enter().append('text')
                    .attr('class', 'node-label')
                    .text(d => this.truncateTitle(d.title, 12));
                
                // Add tooltips
                node
                    .on('mouseover', (event, d) => this.showTooltip(event, d))
                    .on('mouseout', () => this.hideTooltip())
                    .on('click', (event, d) => {
                        // Navigate to note on click
                        window.location.href = `/note/${d.id}`;
                    });
                
                // Update positions
                this.simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    label
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                });
            }
            
            getNodeRadius(node) {
                return 6 + Math.min(node.size * 1.5, 12);
            }
            
            getNodeColor(node) {
                const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
                return colors[node.group % colors.length];
            }
            
            truncateTitle(title, maxLength) {
                return title.length > maxLength ? title.substring(0, maxLength) + '...' : title;
            }
            
            showTooltip(event, node) {
                this.tooltip.style.display = 'block';
                this.tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">${node.title}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">
                        Tags: ${node.tags.slice(0, 3).join(', ')}${node.tags.length > 3 ? '...' : ''}<br>
                        Connections: ${node.size}
                    </div>
                `;
                this.tooltip.style.left = (event.pageX + 10) + 'px';
                this.tooltip.style.top = (event.pageY - 10) + 'px';
            }
            
            hideTooltip() {
                this.tooltip.style.display = 'none';
            }
            
            drag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }
        
        // Initialize embedded graph when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for the container to have proper dimensions
            setTimeout(() => {
                new EmbeddedGraph();
            }, 100);
        });
    </script>
</body>
</html>