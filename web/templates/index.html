<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Notes</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    {{if .Config.WebUICustomCSS}}
    <link rel="stylesheet" href="/static/css/custom.css">
    {{end}}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        // Prevent theme flash by setting theme before page renders
        (function() {
            const savedTheme = localStorage.getItem('ml-notes-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Embedded Graph Styles */
        .embedded-graph-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--paper-bg);
            margin: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            box-shadow: 0 8px 32px rgba(var(--shadow-color), 0.12);
            overflow: hidden;
        }

        .embedded-graph-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .embedded-graph-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .graph-header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .graph-stats {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .embedded-graph-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--paper-bg);
        }

        .embedded-graph-tooltip {
            position: absolute;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(var(--shadow-color), 0.15);
            pointer-events: none;
            z-index: 20;
            max-width: 250px;
        }

        .embedded-graph .node {
            stroke: var(--border-color);
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .embedded-graph .node:hover {
            stroke-width: 3px;
            filter: brightness(1.1);
        }

        .embedded-graph .link {
            stroke: var(--border-color);
            stroke-opacity: 0.4;
            stroke-width: 1px;
        }

        .embedded-graph .node-label {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 500;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
            dominant-baseline: central;
        }

        /* Delete Modal Styles */
        .delete-confirmation {
            text-align: center;
            padding: 20px 0;
        }

        .delete-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .delete-confirmation h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .delete-warning {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .note-preview-delete {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            font-size: 14px;
            color: var(--text-primary);
            text-align: left;
        }

        .note-preview-delete strong {
            color: var(--text-secondary);
        }

        /* Side-by-Side Editor */
        .side-by-side-editor {
            display: flex;
            flex: 1;
            min-height: 500px;
            gap: 1px;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .editor-pane, .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--paper-bg);
            transition: flex 0.3s ease, transform 0.3s ease;
            overflow: hidden;
        }

        /* Sliding states */
        .side-by-side-editor.hide-editor .editor-pane {
            flex: 0;
            transform: translateX(-100%);
        }

        .side-by-side-editor.hide-preview .preview-pane {
            flex: 0;
            transform: translateX(100%);
        }

        .side-by-side-editor.hide-editor .preview-pane,
        .side-by-side-editor.hide-preview .editor-pane {
            flex: 1;
        }

        .pane-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pane-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pane-toggle {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .pane-toggle:hover {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        .editor-textarea {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            padding: 16px;
            font-family: 'Crimson Text', 'Libre Baskerville', Georgia, serif;
            font-weight: 400;
            resize: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .editor-textarea:focus {
            outline: none;
        }

        .editor-textarea::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }

        .preview-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            font-family: 'Crimson Text', 'Libre Baskerville', Georgia, serif;
            color: var(--text-primary);
        }

        /* Preview Markdown Styling */
        .preview-content h1, .preview-content h2, .preview-content h3, 
        .preview-content h4, .preview-content h5, .preview-content h6 {
            color: var(--text-primary);
            font-weight: 600;
            margin: 20px 0 12px 0;
            font-family: 'Inter', system-ui, sans-serif;
        }

        .preview-content h1 { font-size: 2em; }
        .preview-content h2 { font-size: 1.5em; }
        .preview-content h3 { font-size: 1.3em; }
        .preview-content h4 { font-size: 1.1em; }
        .preview-content h5 { font-size: 1em; font-weight: 700; }
        .preview-content h6 { font-size: 0.9em; font-weight: 700; color: var(--text-secondary); }

        .preview-content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .preview-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .preview-content em {
            font-style: italic;
            color: var(--text-primary);
        }

        .preview-content code {
            background: var(--bg-secondary);
            color: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 0.9em;
        }

        .preview-content pre {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .preview-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .preview-content blockquote {
            border-left: 3px solid var(--accent-color);
            margin: 12px 0;
            padding: 8px 0 8px 16px;
            color: var(--text-secondary);
            font-style: italic;
            background: var(--bg-secondary);
            border-radius: 0 4px 4px 0;
        }

        .preview-content ul, .preview-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .preview-content li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .preview-content a {
            color: var(--accent-color);
            text-decoration: underline;
            text-decoration-color: var(--accent-color);
            text-underline-offset: 2px;
        }

        .preview-content a:hover {
            color: var(--accent-hover);
            text-decoration-color: var(--accent-hover);
        }

        .preview-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }

        .preview-content th, .preview-content td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .preview-content th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 8px 0;
        }

        /* Show panel toggles */
        .show-editor-toggle, .show-preview-toggle {
            position: absolute;
            top: 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(var(--shadow-color), 0.2);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .show-editor-toggle {
            left: 0;
        }

        .show-preview-toggle {
            right: 0;
            border-radius: 8px 0 0 8px;
        }

        .show-editor-toggle:hover, .show-preview-toggle:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(var(--shadow-color), 0.25);
        }

        /* Project Selector Styles */
        .project-selector {
            position: relative;
            display: inline-block;
            margin: 0 16px;
        }

        .project-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--button-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-btn:hover {
            background: var(--button-hover);
            border-color: var(--border-hover);
        }

        .project-icon {
            font-size: 16px;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s ease;
        }

        .project-btn.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .project-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 250px;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(var(--shadow-color), 0.15);
            z-index: 1000;
            margin-top: 4px;
        }

        .project-dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn-mini {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s ease;
        }

        .btn-mini:hover {
            background: var(--accent-hover);
        }

        .project-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .project-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s ease;
        }

        .project-item:hover {
            background: var(--note-item-hover);
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .project-item.current {
            background: var(--note-item-active);
            border-left: 3px solid var(--accent-color);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .project-meta {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .project-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .project-item:hover .project-actions {
            opacity: 1;
        }

        .project-action-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .project-action-btn:hover {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        .project-action-btn.danger:hover {
            background: var(--danger-color);
            color: white;
        }

        /* Project Creation Modal Styles */
        .project-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .project-modal-content {
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(var(--shadow-color), 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .project-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .project-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        .project-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
        }
        
        .project-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .project-form-group {
            display: flex;
            flex-direction: column;
        }

        .project-form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .project-form-input,
        .project-form-textarea {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .project-form-input:focus,
        .project-form-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .project-form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .project-form-help {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* File Upload Styles */
        .attachments-section {
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            background: var(--card-bg);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-header label {
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .file-upload-area {
            margin: 16px 0;
        }

        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: var(--accent-color);
            background: var(--accent-color);
            background-opacity: 0.1;
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .drop-zone-content p {
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--accent-color);
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
            pointer-events: auto;
        }

        .link-button:hover {
            color: var(--accent-hover);
        }

        .upload-progress {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .attachments-list {
            margin-top: 16px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--paper-bg);
            transition: background 0.2s ease;
        }

        .attachment-item:hover {
            background: var(--note-item-hover);
        }

        .attachment-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .attachment-icon {
            font-size: 24px;
            width: 32px;
            text-align: center;
        }

        .attachment-details {
            flex: 1;
        }

        .attachment-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .attachment-meta {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .attachment-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .btn-icon:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-icon.danger:hover {
            background: var(--danger-color);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .side-by-side-editor {
                flex-direction: column;
            }
            
            .editor-pane, .preview-pane {
                min-height: 250px;
            }

            .show-editor-toggle, .show-preview-toggle {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                border-radius: 8px;
                margin: 10px;
            }

            .project-dropdown {
                position: fixed;
                top: 60px;
                left: 10px;
                right: 10px;
                min-width: auto;
            }
        }
    </style>
</head>
<body data-theme="{{if .Config.WebUITheme}}{{.Config.WebUITheme}}{{else}}dark{{end}}">
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <a href="/" class="app-title" style="text-decoration: none;">üìù ML Notes</a>
                
                <!-- Project Selector -->
                <div class="project-selector">
                    <button id="project-dropdown-btn" class="project-btn" title="Switch Project">
                        <span class="project-icon">üìÅ</span>
                        <span id="current-project-name">{{.Config.CurrentProject}}</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div id="project-dropdown" class="project-dropdown" style="display: none;">
                        <div class="project-dropdown-header">
                            <span>Projects</span>
                            <button id="new-project-btn" class="btn-mini" title="New Project">+</button>
                        </div>
                        <div id="project-list" class="project-list">
                            <!-- Projects will be loaded dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="stats">
                    <span class="stat-item">{{.Stats.TotalNotes}} notes</span>
                </div>
            </div>
            <div class="header-right">
                <button id="new-note-btn" class="btn btn-primary">
                    <span class="btn-icon">+</span>
                    New Note
                </button>
                <a href="/projects" class="btn btn-secondary" title="Manage projects">
                    <span class="btn-icon">üìÅ</span>
                    Projects
                </a>
                <a href="/graph" class="btn btn-secondary" title="View notes graph">
                    <span class="btn-icon">üìä</span>
                    Graph
                </a>
                <a href="/settings" class="btn btn-secondary" title="Application settings">
                    <span class="btn-icon">‚öôÔ∏è</span>
                    Settings
                </a>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search notes..." class="search-input">
                    <button id="search-btn" class="search-btn">üîç</button>
                </div>
                <button id="theme-toggle" class="btn btn-icon-only" title="Toggle theme">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>Notes</h3>
                    <div class="sidebar-controls">
                        <select id="tag-filter" class="tag-filter">
                            <option value="">All Tags</option>
                            {{range .Tags}}
                            <option value="{{.Name}}">{{.Name}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
                
                <div class="notes-list" id="notes-list">
                    {{if .Notes}}
                        {{range .Notes}}
                        <div class="note-item {{if eq $.CurrentNote.ID .ID}}active{{end}}" data-note-id="{{.ID}}" data-tags="{{range .Tags}}{{.}} {{end}}">
                            <div class="note-title">{{.Title}}</div>
                            <div class="note-preview">{{printf "%.100s" .Content}}{{if gt (len .Content) 100}}...{{end}}</div>
                            <div class="note-meta">
                                <span class="note-date">{{.CreatedAt.Format "Jan 2, 2006"}}</span>
                                {{if .Tags}}
                                <div class="note-tags">
                                    {{range .Tags}}
                                    <span class="tag">{{.}}</span>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="empty-state">
                            <p>No notes yet. Create your first note!</p>
                        </div>
                    {{end}}
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="editor-container">
                    {{if .CurrentNote}}
                        <!-- Note Editor -->
                        <div class="note-editor paper-page paper-shadow-lg" id="note-editor">
                            <!-- Hidden field for note ID -->
                            <input type="hidden" id="current-note-id" value="{{.CurrentNote.ID}}">
                            
                            <div class="editor-header">
                                <input type="text" id="note-title" class="note-title-input" value="{{.CurrentNote.Title}}" placeholder="{{if .IsNewNote}}Enter your note title...{{else}}Note title...{{end}}">
                                <div class="editor-actions">
                                    {{if not .IsNewNote}}
                                    <button id="auto-tag-btn" class="btn btn-secondary" {{if not .Stats.AutoTagging}}disabled{{end}}>
                                        üè∑Ô∏è Auto-tag
                                    </button>
                                    <button id="analyze-btn" class="btn btn-secondary">
                                        ü§ñ Analyze
                                    </button>
                                    {{end}}
                                    <button id="save-note" class="btn btn-primary">{{if .IsNewNote}}Create Note{{else}}Save{{end}}</button>
                                    {{if not .IsNewNote}}
                                    <button id="delete-note" class="btn btn-danger">Delete</button>
                                    {{end}}
                                </div>
                            </div>

                            <!-- Tags Section -->
                            <div class="tags-section">
                                <label>Tags:</label>
                                <div class="tags-input-container">
                                    <input type="text" id="note-tags" placeholder="Add tags (comma-separated)" value="{{range $i, $tag := .CurrentNote.Tags}}{{if $i}}, {{end}}{{$tag}}{{end}}">
                                </div>
                                <div class="current-tags" id="current-tags">
                                    {{range .CurrentNote.Tags}}
                                    <span class="tag removable" data-tag="{{.}}">{{.}} <span class="tag-remove">√ó</span></span>
                                    {{end}}
                                </div>
                            </div>

                            <!-- File Attachments Section -->
                            {{if not .IsNewNote}}
                            <div class="attachments-section">
                                <div class="section-header">
                                    <label>üìé File Attachments</label>
                                    <button id="upload-toggle-btn" class="btn btn-secondary btn-sm">Upload Files</button>
                                </div>
                                
                                <!-- File Upload Area (initially hidden) -->
                                <div id="file-upload-area" class="file-upload-area" style="display: none;">
                                    <div class="file-drop-zone" id="file-drop-zone">
                                        <div class="drop-zone-content">
                                            <div class="drop-icon">üìÅ</div>
                                            <p>Drag and drop files here, or <button type="button" class="link-button" id="file-select-btn">click to select</button></p>
                                            <small>Maximum file size: 100MB</small>
                                        </div>
                                        <input type="file" id="file-input" multiple style="display: none;">
                                    </div>
                                    <div class="upload-progress" id="upload-progress" style="display: none;">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="progress-fill"></div>
                                        </div>
                                        <div class="progress-text" id="progress-text">Uploading...</div>
                                    </div>
                                </div>
                                
                                <!-- Existing Attachments -->
                                <div class="attachments-list" id="attachments-list">
                                    {{range .CurrentNote.Attachments}}
                                    <div class="attachment-item" data-attachment-id="{{.ID}}">
                                        <div class="attachment-info">
                                            <div class="attachment-icon">
                                                {{if hasPrefix .MimeType "image/"}}üì∑{{else if hasPrefix .MimeType "text/"}}üìÑ{{else if hasPrefix .MimeType "application/pdf"}}üìÑ{{else}}üìé{{end}}
                                            </div>
                                            <div class="attachment-details">
                                                <div class="attachment-name">{{.OriginalName}}</div>
                                                <div class="attachment-meta">{{formatFileSize .FileSize}} ‚Ä¢ {{formatTime .CreatedAt}}</div>
                                            </div>
                                        </div>
                                        <div class="attachment-actions">
                                            {{if hasPrefix .MimeType "image/"}}
                                            <button class="btn-icon" onclick="insertImageIntoEditor('{{.Filename}}', '{{.OriginalName}}')" title="Insert image">üñºÔ∏è</button>
                                            {{end}}
                                            <a href="/api/v1/files/{{.Filename}}" class="btn-icon" target="_blank" title="Download">‚¨áÔ∏è</a>
                                            <button class="btn-icon danger" onclick="deleteAttachment({{.ID}})" title="Delete">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}

                            <!-- Side-by-Side Editor -->
                            <div class="editor-area">
                                <div class="side-by-side-editor" id="side-by-side-editor">
                                    <div class="editor-pane" id="editor-pane">
                                        <div class="pane-header">
                                            <span class="pane-title">‚úèÔ∏è Write</span>
                                            <button class="pane-toggle" id="hide-editor" title="Hide editor">‚Æú</button>
                                        </div>
                                        <textarea id="note-content" class="editor-textarea" placeholder="{{if .IsNewNote}}Start writing your note here...{{else}}Start writing your note...{{end}}">{{.CurrentNote.Content}}</textarea>
                                    </div>
                                    <div class="preview-pane" id="preview-pane">
                                        <div class="pane-header">
                                            <span class="pane-title">üëÅÔ∏è Preview</span>
                                            <button class="pane-toggle" id="hide-preview" title="Hide preview">‚Æû</button>
                                        </div>
                                        <div id="note-preview" class="preview-content"></div>
                                    </div>
                                </div>
                                
                                <!-- Hidden pane toggles (shown when panes are closed) -->
                                <div class="show-editor-toggle" id="show-editor" style="display: none;" title="Show editor">
                                    <span>‚úèÔ∏è</span>
                                </div>
                                <div class="show-preview-toggle" id="show-preview" style="display: none;" title="Show preview">
                                    <span>üëÅÔ∏è</span>
                                </div>
                            </div>

                            <input type="hidden" id="current-note-id" value="{{.CurrentNote.ID}}">
                            <input type="hidden" id="is-new-note" value="{{.IsNewNote}}">
                        </div>
                    {{else}}
                        {{if and .Notes (gt (len .Notes) 1)}}
                            <!-- Embedded Graph View -->
                            <div class="embedded-graph-container">
                                <div class="embedded-graph-header">
                                    <h2>üìä Notes Graph</h2>
                                    <div class="graph-header-actions">
                                        <span class="graph-stats" id="embedded-graph-stats">{{len .Notes}} notes</span>
                                        <a href="/graph" class="btn btn-secondary">Full View</a>
                                    </div>
                                </div>
                                <div class="embedded-graph-content">
                                    <svg id="embedded-graph" width="100%" height="100%"></svg>
                                    <div class="embedded-graph-tooltip" id="embedded-tooltip" style="display: none;"></div>
                                </div>
                            </div>
                        {{else}}
                            <!-- Welcome Screen for Empty State -->
                            <div class="welcome-screen">
                                <div class="welcome-content">
                                    <h2>Welcome to ML Notes</h2>
                                    <p>Start creating notes to see them visualized as an interactive graph.</p>
                                    <button id="create-first-note" class="btn btn-primary btn-large">
                                        Create Your First Note
                                    </button>
                                </div>
                            </div>
                        {{end}}
                    {{end}}
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;"></div>
    
    <!-- Analysis Modal -->
    <div id="analysis-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Note Analysis</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="analysis-options">
                    <label>
                        <input type="checkbox" id="analysis-write-back"> Write analysis back to note
                    </label>
                    <label>
                        <input type="checkbox" id="analysis-write-new"> Create new note with analysis
                    </label>
                    <div id="analysis-title-input" style="display: none;">
                        <input type="text" placeholder="Analysis note title..." id="analysis-title">
                    </div>
                    <div class="prompt-input">
                        <label for="analysis-prompt">Custom prompt (optional):</label>
                        <textarea id="analysis-prompt" placeholder="e.g., Focus on technical details, Extract key insights..."></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button id="run-analysis" class="btn btn-primary">Analyze</button>
                </div>
            </div>
            <div id="analysis-result" class="analysis-result" style="display: none;">
                <div class="analysis-content"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Note</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation">
                    <div class="delete-icon">üóëÔ∏è</div>
                    <h4 id="delete-note-title">Are you sure you want to delete this note?</h4>
                    <p class="delete-warning">This action cannot be undone. The note and all its content will be permanently deleted.</p>
                    <div class="note-preview-delete">
                        <strong>Note:</strong> <span id="delete-preview-title"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button id="confirm-delete" class="btn btn-danger">Delete Note</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Enhanced Editor - Simple layered preview
        class EnhancedEditor {
            constructor(textarea, preview) {
                this.textarea = textarea;
                this.preview = preview;
                this.renderTimeout = null;
                
                this.init();
            }
            
            init() {
                this.textarea.addEventListener('input', () => this.handleInput());
                this.textarea.addEventListener('scroll', () => this.syncScroll());
                this.updatePreview();
            }
            
            handleInput() {
                clearTimeout(this.renderTimeout);
                this.renderTimeout = setTimeout(() => {
                    this.updatePreview();
                }, 50);
            }
            
            syncScroll() {
                const scrollPercentage = this.textarea.scrollTop / (this.textarea.scrollHeight - this.textarea.clientHeight);
                const targetScrollTop = scrollPercentage * (this.preview.scrollHeight - this.preview.clientHeight);
                this.preview.scrollTop = targetScrollTop;
            }
            
            updatePreview() {
                const markdown = this.textarea.value;
                if (!markdown.trim()) {
                    this.preview.innerHTML = '';
                    return;
                }
                
                try {
                    let html = marked.parse(markdown);
                    
                    if (window.DOMPurify) {
                        html = DOMPurify.sanitize(html);
                    }
                    
                    this.preview.innerHTML = html;
                    this.syncScroll();
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                }
            }
            
            getContent() {
                return this.textarea.value;
            }
        }
        // Embedded Graph Functionality
        class EmbeddedGraph {
            constructor() {
                this.container = document.getElementById('embedded-graph');
                this.tooltip = document.getElementById('embedded-tooltip');
                
                if (!this.container) return;
                
                this.init();
                this.loadData();
            }
            
            init() {
                const containerRect = this.container.closest('.embedded-graph-content').getBoundingClientRect();
                this.width = containerRect.width || 800;
                this.height = containerRect.height || 600;
                
                this.svg = d3.select(this.container)
                    .attr('width', this.width)
                    .attr('height', this.height)
                    .attr('class', 'embedded-graph');
                
                this.g = this.svg.append('g');
                
                // Simple zoom (no complex controls for embedded view)
                const zoom = d3.zoom()
                    .scaleExtent([0.3, 3])
                    .on('zoom', (event) => {
                        this.g.attr('transform', event.transform);
                    });
                
                this.svg.call(zoom);
                
                this.linkGroup = this.g.append('g').attr('class', 'links');
                this.nodeGroup = this.g.append('g').attr('class', 'nodes');
                this.labelGroup = this.g.append('g').attr('class', 'labels');
            }
            
            async loadData() {
                try {
                    const response = await fetch('/api/v1/graph?max_nodes=30&min_connections=1');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.render(data.data);
                        this.updateStats(data.data.nodes.length, data.data.links.length);
                    }
                } catch (error) {
                    console.error('Error loading embedded graph:', error);
                }
            }
            
            updateStats(nodeCount, linkCount) {
                const statsEl = document.getElementById('embedded-graph-stats');
                if (statsEl) {
                    statsEl.textContent = `${nodeCount} notes, ${linkCount} connections`;
                }
            }
            
            render(data) {
                this.nodes = data.nodes.map(node => ({
                    ...node,
                    x: Math.random() * this.width,
                    y: Math.random() * this.height
                }));
                
                this.links = data.links.map(link => ({
                    ...link,
                    source: this.nodes.find(n => n.id === link.source),
                    target: this.nodes.find(n => n.id === link.target)
                }));
                
                // Create simulation with special handling for isolated nodes
                this.simulation = d3.forceSimulation(this.nodes)
                    .force('link', d3.forceLink(this.links)
                        .id(d => d.id)
                        .distance(80)
                        .strength(0.6)
                    )
                    .force('charge', d3.forceManyBody()
                        .strength(d => {
                            // Reduce repulsion for isolated nodes (no connections)
                            return d.size === 0 ? -30 : -200;
                        })
                    )
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(d => this.getNodeRadius(d) + 3))
                    // Add a positioning force to keep isolated nodes closer to center
                    .force('position', d3.forceRadial()
                        .radius(d => {
                            // Keep isolated nodes closer to center
                            if (d.size === 0) {
                                return Math.min(this.width, this.height) * 0.15; // 15% from center
                            }
                            return Math.min(this.width, this.height) * 0.35; // 35% from center for connected nodes
                        })
                        .x(this.width / 2)
                        .y(this.height / 2)
                        .strength(d => d.size === 0 ? 0.4 : 0.1) // Stronger for isolated nodes
                    );
                
                // Render links
                const link = this.linkGroup.selectAll('.link')
                    .data(this.links)
                    .enter().append('line')
                    .attr('class', 'link')
                    .attr('stroke-width', d => 1 + d.weight * 2);
                
                // Render nodes
                const node = this.nodeGroup.selectAll('.node')
                    .data(this.nodes)
                    .enter().append('circle')
                    .attr('class', 'node')
                    .attr('r', d => this.getNodeRadius(d))
                    .attr('fill', d => this.getNodeColor(d))
                    .call(this.drag());
                
                // Render labels (only for larger nodes to avoid clutter)
                const label = this.labelGroup.selectAll('.node-label')
                    .data(this.nodes.filter(d => d.size >= 2))
                    .enter().append('text')
                    .attr('class', 'node-label')
                    .text(d => this.truncateTitle(d.title, 12));
                
                // Add tooltips
                node
                    .on('mouseover', (event, d) => this.showTooltip(event, d))
                    .on('mouseout', () => this.hideTooltip())
                    .on('click', (event, d) => {
                        // Navigate to note on click
                        window.location.href = `/note/${d.id}`;
                    });
                
                // Update positions
                this.simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    label
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                });
            }
            
            getNodeRadius(node) {
                return 6 + Math.min(node.size * 1.5, 12);
            }
            
            getNodeColor(node) {
                // Get theme-aware colors from CSS custom properties
                const root = document.documentElement;
                const accentColor = getComputedStyle(root).getPropertyValue('--accent-color').trim();
                const successColor = '#10b981';
                const warningColor = '#f59e0b';
                const dangerColor = getComputedStyle(root).getPropertyValue('--danger-color').trim() || '#ef4444';
                const colors = [accentColor, successColor, warningColor, dangerColor, '#8b5cf6', '#06b6d4'];
                return colors[node.group % colors.length];
            }
            
            truncateTitle(title, maxLength) {
                return title.length > maxLength ? title.substring(0, maxLength) + '...' : title;
            }
            
            showTooltip(event, node) {
                this.tooltip.style.display = 'block';
                this.tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">${node.title}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">
                        Tags: ${node.tags.slice(0, 3).join(', ')}${node.tags.length > 3 ? '...' : ''}<br>
                        Connections: ${node.size}
                    </div>
                `;
                this.tooltip.style.left = (event.pageX + 10) + 'px';
                this.tooltip.style.top = (event.pageY - 10) + 'px';
            }
            
            hideTooltip() {
                this.tooltip.style.display = 'none';
            }
            
            drag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }
        
        // Project Management Class
        class ProjectManager {
            constructor() {
                this.setupEventListeners();
                this.loadProjects();
            }
            
            setupEventListeners() {
                // Project dropdown toggle
                const projectBtn = document.getElementById('project-dropdown-btn');
                const projectDropdown = document.getElementById('project-dropdown');
                
                if (projectBtn && projectDropdown) {
                    projectBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!projectDropdown.contains(e.target) && !projectBtn.contains(e.target)) {
                            this.closeDropdown();
                        }
                    });
                }
                
                // New project button
                const newProjectBtn = document.getElementById('new-project-btn');
                if (newProjectBtn) {
                    newProjectBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showCreateProjectModal();
                    });
                }
            }
            
            toggleDropdown() {
                const dropdown = document.getElementById('project-dropdown');
                const isVisible = dropdown.style.display === 'block';
                
                if (isVisible) {
                    this.closeDropdown();
                } else {
                    this.openDropdown();
                }
            }
            
            openDropdown() {
                const dropdown = document.getElementById('project-dropdown');
                dropdown.style.display = 'block';
                // Load fresh project list when opening
                this.loadProjects();
            }
            
            closeDropdown() {
                const dropdown = document.getElementById('project-dropdown');
                dropdown.style.display = 'none';
            }
            
            async loadProjects() {
                try {
                    const response = await fetch('/api/v1/projects');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.renderProjectList(result.data.projects);
                    } else {
                        console.error('Failed to load projects:', result.error);
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                }
            }
            
            renderProjectList(projects) {
                const projectList = document.getElementById('project-list');
                if (!projectList) return;
                
                projectList.innerHTML = '';
                
                projects.forEach(project => {
                    const projectItem = document.createElement('div');
                    projectItem.className = 'project-item';
                    
                    const currentProject = document.getElementById('current-project-name').textContent.trim();
                    if (project.name === currentProject) {
                        projectItem.classList.add('current-project');
                    }
                    
                    projectItem.innerHTML = `
                        <div class="project-item-main">
                            <div class="project-item-name">${project.display_name || project.name}</div>
                            <div class="project-item-desc">${project.description || 'No description'}</div>
                        </div>
                        <div class="project-item-actions">
                            ${project.name !== currentProject ? 
                                `<button class="project-action-btn" onclick="projectManager.switchProject('${project.name}')" title="Switch to project">üîÑ</button>` : 
                                `<span class="current-indicator" title="Current project">‚úì</span>`
                            }
                            ${project.name !== 'default' && project.name !== currentProject ? 
                                `<button class="project-action-btn delete-btn" onclick="projectManager.deleteProject('${project.name}')" title="Delete project">üóëÔ∏è</button>` : 
                                ''
                            }
                        </div>
                    `;
                    
                    // Add click handler for switching projects
                    if (project.name !== currentProject) {
                        projectItem.addEventListener('click', (e) => {
                            // Don't trigger if clicking on action buttons
                            if (!e.target.classList.contains('project-action-btn')) {
                                this.switchProject(project.name);
                            }
                        });
                    }
                    
                    projectList.appendChild(projectItem);
                });
            }
            
            async switchProject(projectName) {
                try {
                    const response = await fetch(`/api/v1/projects/${projectName}/switch`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update current project name in UI
                        document.getElementById('current-project-name').textContent = projectName;
                        this.closeDropdown();
                        // Refresh the page to load notes from the new project
                        window.location.reload();
                    } else {
                        alert(`Failed to switch project: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error switching project:', error);
                    alert(`Error switching project: ${error.message}`);
                }
            }
            
            async deleteProject(projectName) {
                if (!confirm(`Are you sure you want to delete the project "${projectName}"? This will permanently delete all notes in this project.`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/v1/projects/${projectName}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        // Refresh project list
                        this.loadProjects();
                    } else {
                        alert(`Failed to delete project: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting project:', error);
                    alert(`Error deleting project: ${error.message}`);
                }
            }
            
            showCreateProjectModal() {
                // Create modal HTML
                const modalHTML = `
                    <div id="project-modal" class="project-modal">
                        <div class="project-modal-content">
                            <div class="project-modal-header">
                                <h3>Create New Project</h3>
                                <button id="close-project-modal" class="close-btn">√ó</button>
                            </div>
                            <form id="create-project-form" class="project-form">
                                <div class="project-form-group">
                                    <label for="project-name">Project Name*</label>
                                    <input type="text" id="project-name" name="name" required 
                                           placeholder="my-project" pattern="[a-zA-Z0-9_-]+" maxlength="50">
                                    <div class="project-form-help">Only letters, numbers, hyphens, and underscores allowed</div>
                                </div>
                                <div class="project-form-group">
                                    <label for="project-display-name">Display Name</label>
                                    <input type="text" id="project-display-name" name="display_name" 
                                           placeholder="My Project" maxlength="100">
                                    <div class="project-form-help">Human-readable name for the project</div>
                                </div>
                                <div class="project-form-group">
                                    <label for="project-description">Description</label>
                                    <textarea id="project-description" name="description" 
                                              placeholder="Optional project description..." maxlength="500"></textarea>
                                </div>
                                <div class="project-form-actions">
                                    <button type="button" id="cancel-project" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Create Project</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('project-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Setup modal event listeners
                const modal = document.getElementById('project-modal');
                const closeBtn = document.getElementById('close-project-modal');
                const cancelBtn = document.getElementById('cancel-project');
                const form = document.getElementById('create-project-form');
                const nameInput = document.getElementById('project-name');
                const displayNameInput = document.getElementById('project-display-name');
                
                // Auto-populate display name from project name
                nameInput.addEventListener('input', (e) => {
                    if (!displayNameInput.value) {
                        const displayName = e.target.value
                            .replace(/[-_]/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                        displayNameInput.value = displayName;
                    }
                });
                
                // Close modal handlers
                const closeModal = () => {
                    modal.remove();
                    this.closeDropdown();
                };
                
                closeBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // Form submission
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createProject(form, closeModal);
                });
                
                // Focus on name input
                nameInput.focus();
            }
            
            async createProject(form, closeModal) {
                const formData = new FormData(form);
                const projectData = {
                    name: formData.get('name').trim(),
                    display_name: formData.get('display_name').trim(),
                    description: formData.get('description').trim()
                };
                
                // Validate project name
                if (!projectData.name.match(/^[a-zA-Z0-9_-]+$/)) {
                    alert('Project name can only contain letters, numbers, hyphens, and underscores.');
                    return;
                }
                
                try {
                    const response = await fetch('/api/v1/projects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(projectData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        closeModal();
                        // Switch to the new project
                        this.switchProject(projectData.name);
                    } else {
                        alert(`Failed to create project: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error creating project:', error);
                    alert(`Error creating project: ${error.message}`);
                }
            }
        }
        
        // Global project manager instance
        let projectManager;

        // Initialize embedded graph when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize project manager
            projectManager = new ProjectManager();
            
            // Wait a bit for the container to have proper dimensions
            setTimeout(() => {
                new EmbeddedGraph();
            }, 100);
            
            // Initialize sliding panel functionality
            initializeSlidingPanels();
            
            // Initialize file upload functionality
            initializeFileUpload();
        });
        
        // Sliding Panel Functionality
        function initializeSlidingPanels() {
            const sideBySideEditor = document.getElementById('side-by-side-editor');
            const hideEditorBtn = document.getElementById('hide-editor');
            const hidePreviewBtn = document.getElementById('hide-preview');
            const showEditorBtn = document.getElementById('show-editor');
            const showPreviewBtn = document.getElementById('show-preview');
            const isNewNoteInput = document.getElementById('is-new-note');
            
            if (!sideBySideEditor) return;
            
            // Set default state based on new note vs viewing existing note
            const isNewNote = isNewNoteInput && isNewNoteInput.value === 'true';
            
            if (isNewNote) {
                // New note: Show both panels (default state)
                sideBySideEditor.classList.remove('hide-editor', 'hide-preview');
                showEditorBtn.style.display = 'none';
                showPreviewBtn.style.display = 'none';
            } else {
                // Viewing existing note: Hide editor, show only preview
                sideBySideEditor.classList.add('hide-editor');
                sideBySideEditor.classList.remove('hide-preview');
                showEditorBtn.style.display = 'block';
                showPreviewBtn.style.display = 'none';
            }
            
            // Hide editor panel
            hideEditorBtn?.addEventListener('click', () => {
                sideBySideEditor.classList.add('hide-editor');
                sideBySideEditor.classList.remove('hide-preview');
                showEditorBtn.style.display = 'block';
                showPreviewBtn.style.display = 'none';
            });
            
            // Hide preview panel  
            hidePreviewBtn?.addEventListener('click', () => {
                sideBySideEditor.classList.add('hide-preview');
                sideBySideEditor.classList.remove('hide-editor');
                showPreviewBtn.style.display = 'block';
                showEditorBtn.style.display = 'none';
            });
            
            // Show editor panel
            showEditorBtn?.addEventListener('click', () => {
                sideBySideEditor.classList.remove('hide-editor');
                showEditorBtn.style.display = 'none';
            });
            
            // Show preview panel
            showPreviewBtn?.addEventListener('click', () => {
                sideBySideEditor.classList.remove('hide-preview');
                showPreviewBtn.style.display = 'none';
            });
        }

        // File Upload Functionality
        function initializeFileUpload() {
            const uploadToggleBtn = document.getElementById('upload-toggle-btn');
            const fileUploadArea = document.getElementById('file-upload-area');
            const fileDropZone = document.getElementById('file-drop-zone');
            const fileSelectBtn = document.getElementById('file-select-btn');
            const fileInput = document.getElementById('file-input');
            const uploadProgress = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (!uploadToggleBtn || !fileUploadArea) return;

            // Toggle upload area visibility
            uploadToggleBtn.addEventListener('click', () => {
                const isVisible = fileUploadArea.style.display !== 'none';
                fileUploadArea.style.display = isVisible ? 'none' : 'block';
                uploadToggleBtn.textContent = isVisible ? 'Upload Files' : 'Hide Upload';
            });

            // File select button
            fileSelectBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            // File input change
            fileInput?.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFiles(Array.from(e.target.files));
                }
            });

            // Drag and drop events
            if (fileDropZone) {
                fileDropZone.addEventListener('click', () => {
                    fileInput.click();
                });

                fileDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.add('drag-over');
                });

                fileDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('drag-over');
                });

                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('drag-over');
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        handleFiles(files);
                    }
                });
            }

            async function handleFiles(files) {
                const noteId = document.getElementById('current-note-id')?.value;
                if (!noteId) {
                    alert('Please save the note first before uploading files.');
                    return;
                }

                // Show progress
                uploadProgress.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = 'Preparing upload...';

                let completedUploads = 0;
                const totalFiles = files.length;

                for (const file of files) {
                    try {
                        // Validate file size (100MB limit)
                        if (file.size > 100 * 1024 * 1024) {
                            alert(`File "${file.name}" is too large. Maximum size is 100MB.`);
                            continue;
                        }

                        const formData = new FormData();
                        formData.append('file', file);

                        progressText.textContent = `Uploading ${file.name}...`;

                        const response = await fetch(`/api/v1/notes/${noteId}/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (response.ok && result) {
                            // Add attachment to the UI
                            addAttachmentToUI(result);
                        } else {
                            throw new Error(result.error || 'Upload failed');
                        }

                        completedUploads++;
                        const progress = (completedUploads / totalFiles) * 100;
                        progressFill.style.width = `${progress}%`;

                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                    }
                }

                // Hide progress after a brief delay
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    progressText.textContent = 'Upload complete';
                }, 1000);

                // Clear file input
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            function addAttachmentToUI(attachment) {
                const attachmentsList = document.getElementById('attachments-list');
                if (!attachmentsList) return;

                // Create attachment element
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.setAttribute('data-attachment-id', attachment.id);

                // Determine icon based on mime type
                let icon = 'üìé';
                if (attachment.mime_type.startsWith('image/')) {
                    icon = 'üì∑';
                } else if (attachment.mime_type.startsWith('text/') || attachment.mime_type === 'application/pdf') {
                    icon = 'üìÑ';
                }

                // Format file size
                const fileSize = formatFileSize(attachment.file_size);
                const createdAt = new Date(attachment.created_at).toLocaleDateString();

                attachmentItem.innerHTML = `
                    <div class="attachment-info">
                        <div class="attachment-icon">${icon}</div>
                        <div class="attachment-details">
                            <div class="attachment-name">${attachment.original_name}</div>
                            <div class="attachment-meta">${fileSize} ‚Ä¢ ${createdAt}</div>
                        </div>
                    </div>
                    <div class="attachment-actions">
                        ${attachment.mime_type.startsWith('image/') ? 
                            `<button class="btn-icon" onclick="insertImageIntoEditor('${attachment.filename}', '${attachment.original_name}')" title="Insert image">üñºÔ∏è</button>` : 
                            ''
                        }
                        <a href="/api/v1/files/${attachment.filename}" class="btn-icon" target="_blank" title="Download">‚¨áÔ∏è</a>
                        <button class="btn-icon danger" onclick="deleteAttachment(${attachment.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                `;

                attachmentsList.appendChild(attachmentItem);
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // Global functions for attachment management
        async function deleteAttachment(attachmentId) {
            if (!confirm('Are you sure you want to delete this attachment?')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/attachments/${attachmentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    // Remove attachment from UI
                    const attachmentItem = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
                    if (attachmentItem) {
                        attachmentItem.remove();
                    }
                } else {
                    throw new Error(result.error || 'Failed to delete attachment');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert(`Failed to delete attachment: ${error.message}`);
            }
        }

        function insertImageIntoEditor(filename, originalName) {
            const editor = document.getElementById('note-content');
            if (!editor) return;

            const imageUrl = `/api/v1/files/${filename}`;
            const altText = originalName.replace(/\.[^/.]+$/, ''); // Remove extension for alt text
            const markdownImage = `![${altText}](${imageUrl})`;

            // Insert at cursor position
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(editor.selectionEnd);
            
            editor.value = textBefore + markdownImage + textAfter;
            
            // Position cursor after the inserted image
            const newCursorPos = cursorPos + markdownImage.length;
            editor.setSelectionRange(newCursorPos, newCursorPos);
            
            // Focus the editor
            editor.focus();
            
            // Trigger input event to update preview
            editor.dispatchEvent(new Event('input', { bubbles: true }));
        }
    </script>
</body>
</html>